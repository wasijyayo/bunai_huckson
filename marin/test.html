<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>逃げろマッチョ</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #1e0044, #9c7995);
      overflow: hidden;
      position: relative;
      width: 100vw;
      height: 100vh;
      font-family: 'Arial', sans-serif;
    }

    #ground {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 200px;
      background: linear-gradient(to bottom, #8B4513, #654321);
      z-index: 1;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
    }

    .hole {
      position: absolute;
      bottom: 0;
      width: 100px;
      height: 200px;
      background: #000000;
      z-index: 2;
      box-shadow: inset 0 5px 15px rgba(0,0,0,0.7);
    }

    @keyframes jumpEffect {
      0% { transform: scaleY(1) rotate(0deg); }
      40% { transform: scaleY(1.1) rotate(-5deg); }
      60% { transform: scaleY(0.9) rotate(5deg); }
      100% { transform: scaleY(1) rotate(0deg); }
    }

    .jumping {
      animation: jumpEffect 0.5s ease-out;
    }
    
    #macho {
      position: absolute;
      bottom: 200px;
      left: 200px;
      width: 180px;
      height: 20px;
      z-index: 10;
      background-image: url("https://ekakikaki.com/wp-content/uploads/2023/07/%E3%83%9E%E3%83%83%E3%83%81%E3%83%A7%EF%BC%91-300x300.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    @keyframes breathe {
      0% { transform: scaleX(1) scaleY(1); }
      50% { transform: scaleX(1.03) scaleY(0.99); }
      100% { transform: scaleX(1) scaleY(1); }
    }

    @keyframes run {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(3deg); }
      75% { transform: rotate(-3deg); }
      100% { transform: rotate(0deg); }
    }
    
    .breathing {
      animation: breathe 2s infinite ease-in-out;
    }

    .running {
      animation: run 0.6s infinite ease-in-out;
    }

    /* 敵 */
    #enemy {
      position: absolute;
      bottom: 200px;
      left: -100px;
      width: 80px; /* 画像の幅に合わせて調整 */
      height: 180px; /* 画像の高さに合わせて調整 */
      background-image: url("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg44EYAGTnkSN-MRACJ3MW3_rmq4Uz5Sl1tCd8ZhvMllkIQG4p700vCSnU7shr-8Dwt9xi-Y1qhas5IXSWc6aZmc0iPxxsZlF2goWce4IY9or-0I7JOv63QVnAKROYdizS3O9CtRy4SYxs/s800/warumono.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 9;
    }
    
    @keyframes enemyMove {
      0% { transform: translateY(0) rotate(0deg); }
      100% { transform: translateY(-3px) rotate(2deg); }
    }

    @keyframes enemyRun {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(12deg); }
      75% { transform: rotate(-12deg); }
      100% { transform: rotate(0deg); }
    }

    .enemy-running .leg.left {
      animation: enemyRun 0.3s infinite ease-in-out;
      transform-origin: top center;
    }

    .enemy-running .leg.right {
      animation: enemyRun 0.3s infinite ease-in-out reverse;
      transform-origin: top center;
    }
    
    /* ゲーム情報 */
    #gameInfo {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #fff;
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 100;
    }
    
    /* スコア表示 */
    #score {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #fff;
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 100;
    }

    /* 音量表示（デバッグ用） */
    #volumeDebug {
      position: absolute;
      top: 60px;
      right: 20px;
      color: #fff;
      font-size: 18px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 100;
    }
    
    /* スタートボタン */
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 24px;
      background-color: #FF8C00;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s, background-color 0.2s;
    }
    
    #startButton:hover {
      background-color: #FF7400;
      transform: translate(-50%, -50%) scale(1.05);
    }
    
  </style>
</head>
<body>
  <div id="gameInfo">マイクに向かって叫ぶと走り、大きな声で叫ぶとジャンプ！</div>
  <div id="score">スコア: 0</div>
  <div id="volumeDebug">音量: 0</div>
  <div id="ground"></div>
  <button id="startButton">ゲームスタート</button>
  
  <div id="macho" class="breathing"></div>

  <div id="enemy" class="enemy-running"></div>> 

  <script>
    // 要素取得と状態管理変数の初期化
    const macho = document.getElementById("macho");
    const enemy = document.getElementById("enemy");
    const scoreElement = document.getElementById("score");
    const volumeDebugElement = document.getElementById("volumeDebug");
    const holes = [];
    const platforms = [];
    const smallPlatforms = [];
    
    // マッチョのステート
    let y = 200, vy = 0, isJumping = false;
    let scrollSpeed = 0;
    let machoX = 200; // 初期位置を設定
    let score = 0;
    let gameRunning = false;
    let groundLevel = 200;  // 現在の接地レベル（段差上だと高くなる）
    
    // 敵のステート
    let enemyX = 100; 
    let enemyY = 200;
    let enemyVy = 0;
    let enemyIsJumping = false;
    let enemyDefeated = false;
    let enemyGroundLevel = 0;  // 敵の接地レベル（地面基準）
    let gameStarted = false;
    let volume = 0; // 音量変数の初期化
    
    // 敵の基本属性
    const enemyWidth = 70;
    const machoWidth = 120;
    const jumpBuffer = 15;  // 余裕の距離

    // スタートボタンクリックイベント
    startButton.addEventListener("click", function() {
      startGame();
      startButton.style.display = "none";
    });
    
    // 開始アニメーション
    function startGame() {
      gameRunning = true;
      gameStarted = true;
      scrollSpeed = 5;
      
      // 敵を地面に配置
      enemyX = -100;
      enemyY = 200;
      enemy.style.left = enemyX + "px";
      enemy.style.bottom = enemyY + "px";
      
      // マッチョを動かす
      updateMachoPosition();
      
      // 走りアニメーションを追加
      macho.classList.add("running");
      enemy.classList.add("enemy-running");
      
      // ゲームループ開始
      requestAnimationFrame(gameLoop);
    }

    // メインゲームループ
    function gameLoop() {
      if (!gameRunning) return;
      
      // 音量表示を更新
      volumeDebugElement.textContent = "音量: " + Math.round(volume);
      
      // マッチョの動きを更新
      if (volume > moveThreshold) {
        macho.classList.add("running");
      } else {
        macho.classList.remove("running");
      }
      
      requestAnimationFrame(gameLoop);
    }

    
    // マッチョの位置更新
    function updateMachoPosition() {
      macho.style.left = machoX + "px";
    }
    
    // ジャンプ処理
    function jump() {
      if (!isJumping && gameStarted && gameRunning) {
        vy = 22;
        isJumping = true;
        macho.classList.add("jumping");
        setTimeout(() => {
          macho.classList.remove("jumping");
        }, 500);
      }
    }
    
    // ゲームオーバー時の処理
    function gameOver(msg = "ゲームオーバー！") {
      gameRunning = false;
      alert(msg + "\nスコア: " + score);
      location.reload();
    }
    
    // 物理演算とアニメーションの更新 (高頻度)
    setInterval(() => {
      if (!gameRunning) return;
      
      // マッチョのジャンプ処理
      if (isJumping) {
        y += vy;
        vy -= 1.2;
        if (y <= groundLevel) {
          y = groundLevel;
          isJumping = false;
        }
        macho.style.bottom = y + "px";
      }
      
      // マッチョの移動処理
      if (scrollSpeed > 0 && gameStarted) {
        machoX += scrollSpeed * 0.1;
        updateMachoPosition();
        
        // スコア加算
        score += 1;
        scoreElement.textContent = "スコア: " + score;
      }
    }, 20);


    // 敵のAI処理 (低頻度)
    setInterval(() => {
      if (!gameRunning || enemyDefeated) return;
      
      // 敵のジャンプ処理
      if (enemyIsJumping) {
        enemyY += enemyVy;
        enemyVy -= 1.2; // 重力
        if (enemyY <= 200) {
          enemyY = 200;
          enemyIsJumping = false;
        }
        enemy.style.bottom = enemyY + "px";
      }

      // 敵の段差認識
      const enemyRect = enemy.getBoundingClientRect();
      
      // 敵が段差の上にいるかチェック
      let enemyOnPlatform = false;
      platforms.concat(smallPlatforms).forEach(platform => {
        const platformRect = platform.getBoundingClientRect();
        if (enemyRect.right > platformRect.left && enemyRect.left < platformRect.right) {
          enemyOnPlatform = true;
          if (!enemyIsJumping) {
            enemyGroundLevel = platform.offsetHeight;
            enemyY = enemyGroundLevel;
            enemy.style.bottom = enemyY + "px";
          }
        }
      });

      // 敵が段差上にいない場合は地面レベルをリセット
      if (!enemyOnPlatform && !enemyIsJumping && enemyGroundLevel > 0) {
        enemyGroundLevel = 0;
        enemyIsJumping = true;
        enemyVy = 0;
      }

      // 敵が穴の手前に来たらジャンプ
      holes.forEach(hole => {
        const holeRect = hole.getBoundingClientRect();
        if (!enemyIsJumping && 
            enemyRect.right > holeRect.left - jumpBuffer && 
            enemyRect.left < holeRect.right) {
          enemyJump();
        }
      });

      // 敵がマッチョを追いかける
      if (gameStarted && !enemyDefeated) {
        if (enemyX < machoX - 300) {
          // 遠い場合は追いつく
          enemyX += 2.5;
        } else if (enemyX < machoX - 200) {
          // 近くなったらゆっくり
          enemyX += 1.5;
        } else if (enemyX < machoX - 150) {
          // さらに近づいたらもっとゆっくり
          enemyX += 0.8;
        }
        
        // 敵の表示位置更新
        enemy.style.left = enemyX + "px";
        
        // 敵に追いつかれてゲームオーバー
        if (enemyX >= machoX - 50 && !enemyDefeated) {
          gameOver("敵に追いつかれた！");
        }
      }
    }, 40);

    // 穴の生成処理
    function createHole() {
      if (!gameRunning || !gameStarted) return;
      
      const hole = document.createElement("div");
      hole.classList.add("hole");
      let pos = window.innerWidth;
      hole.style.left = pos + "px";
      document.body.appendChild(hole);
      holes.push(hole);


      const interval = setInterval(() => {
        if (!gameRunning) {
          clearInterval(interval);
          return;
        }
        
        if (pos < -100) {
          clearInterval(interval);
          hole.remove();
          holes.splice(holes.indexOf(hole), 1);
        } else {
          pos -= scrollSpeed;
          hole.style.left = pos + "px";
        }
      }, 20);
    }

    // 敵のジャンプ処理
    function enemyJump() {
      if (!enemyIsJumping && !enemyDefeated) {
        enemyVy = 22; // ジャンプの初速
        enemyIsJumping = true;
      }
    }

    // 穴との衝突判定
    setInterval(() => {
      if (!isJumping && y <= 200 && gameRunning && gameStarted) {
        const machoRect = macho.getBoundingClientRect();
        const machoLeft = machoRect.left;
        const machoRight = machoRect.right;
        const machoWidth = machoRect.width;
        
        // 各穴との位置関係をチェック
        const isOnHole = holes.some(hole => {
          const holeRect = hole.getBoundingClientRect();
          const holeLeft = holeRect.left;
          const holeRight = holeRect.right;
          
          // マッチョが穴の上にいるかどうか判定
          const overlapping = 
            // マッチョの中心が穴の範囲内
            (machoLeft + machoWidth/2 > holeLeft && 
              machoLeft + machoWidth/2 < holeRight) ||
            // マッチョが穴を完全に覆っている
            (machoLeft < holeLeft && machoRight > holeRight);
          
          return overlapping;
        });
        
        if (isOnHole) {
          gameOver("崖に落ちた！");
        }
      }
    }, 30);

    // 穴の定期生成
    setInterval(() => {
      if (scrollSpeed > 0 && gameStarted && gameRunning) {
        createHole();
      }
    }, 2000);

    // オーディオ入力の処理
    let volumeSmooth = 0;
    const moveThreshold = 5;  // 小さな声で移動
    const jumpThreshold = 40; // 大きな声でジャンプ
    const volumeSmoothFactor = 0.2;
    let lastJumpTime = 0;  // 前回ジャンプした時間
    const jumpCooldown = 800;  // ジャンプのクールダウン時間（ミリ秒）

    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then((stream) => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const mic = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        mic.connect(analyser);
        const data = new Uint8Array(analyser.frequencyBinCount);
        
        // オーディオ分析の実行
        function analyzeAudio() {
          if (!gameRunning) {
            requestAnimationFrame(analyzeAudio);
            return;
          }
          
          analyser.getByteFrequencyData(data);
          
          // 音量の計算
          let sum = 0;
          for (let i = 0; i < data.length; i++) {
            sum += data[i];
          }
          volume = sum / data.length;  // グローバル変数volumeを更新

          // 音量のスムージング
          volumeSmooth = volumeSmooth * 0.8 + volume * 0.2;
          
          // デバッグ表示
          volumeDebugElement.textContent = "音量: " + Math.round(volumeSmooth);

          // 音量に応じたアクション
          const currentTime = Date.now();
          
          if (volumeSmooth > jumpThreshold && !isJumping && currentTime - lastJumpTime > jumpCooldown) {
            // 大きな声でジャンプ
            lastJumpTime = currentTime;
            jump();
          }
          
          if (volumeSmooth > moveThreshold) {
            // 小さな声で移動
            scrollSpeed = 5;
          } else {
            // 無音状態で停止
            scrollSpeed = 0;
          }

          requestAnimationFrame(analyzeAudio);
        }

        analyzeAudio();
      })
      .catch((err) => {
        alert("マイクの使用を許可してください: " + err.message);
        // マイク許可がない場合はキーボード操作を有効にする
        document.addEventListener('keydown', (e) => {
          if (e.code === 'Space' && !isJumping) {
            jump();
          } else if (e.code === 'ArrowRight') {
            scrollSpeed = 5;
          }
        });
        
        document.addEventListener('keyup', (e) => {
          if (e.code === 'ArrowRight') {
            scrollSpeed = 0;
          }
        });
      });
  </script>
</body>
</html>